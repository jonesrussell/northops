name: deploy

on:
  workflow_run:
    workflows: ['tests']
    types: [completed]
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Download Deployer
        run: |
          curl -LO https://deployer.org/deployer.phar
          chmod +x deployer.phar
          sudo mv deployer.phar /usr/local/bin/dep

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PRIVATE_KEY_BASE64: ${{ secrets.SSH_PRIVATE_KEY_BASE64 }}
        run: |
          eval "$(ssh-agent -s)"
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> "$GITHUB_ENV"
          echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> "$GITHUB_ENV"
          if [ -n "$SSH_PRIVATE_KEY_BASE64" ]; then
            echo "Using SSH_PRIVATE_KEY_BASE64"
            echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d | ssh-add -
          else
            echo "Using SSH_PRIVATE_KEY"
            echo "$SSH_PRIVATE_KEY" | ssh-add -
          fi
          echo "Loaded keys:"
          ssh-add -l

      - name: Add Host Key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -T 5 -H northops.ca >> ~/.ssh/known_hosts
          cat >> ~/.ssh/config << EOF
          Host northops.ca
            User deployer
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Test SSH connection
        run: |
          ssh -v -o BatchMode=yes deployer@northops.ca "echo SSH_OK" || true

      - name: Deploy
        run: |
          set -e
          dep deploy northops.ca -v
